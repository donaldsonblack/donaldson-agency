name: Deploy to Production (Self-Hosted)

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual triggers

env:
  DOCKER_IMAGE: donaldson-agency
  DEPLOY_PATH: /opt/donaldson-agency

jobs:
  test:
    name: Test & Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run linter
        run: bun run lint

      - name: Type check
        run: bunx tsc --noEmit

      - name: Build application
        run: bun run build
        env:
          # Dummy values for build (actual values set on server)
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          RESEND_FROM_EMAIL: ${{ secrets.RESEND_FROM_EMAIL }}
          RESEND_TO_EMAIL: ${{ secrets.RESEND_TO_EMAIL }}
          NEXT_PUBLIC_GA_MEASUREMENT_ID: ${{ secrets.NEXT_PUBLIC_GA_MEASUREMENT_ID }}
          NEXT_PUBLIC_GOOGLE_ADS_CONTACT_LABEL: ${{ secrets.NEXT_PUBLIC_GOOGLE_ADS_CONTACT_LABEL }}
          NEXT_PUBLIC_GOOGLE_ADS_PHONE_LABEL: ${{ secrets.NEXT_PUBLIC_GOOGLE_ADS_PHONE_LABEL }}
          NEXT_PUBLIC_GOOGLE_ADS_EMAIL_LABEL: ${{ secrets.NEXT_PUBLIC_GOOGLE_ADS_EMAIL_LABEL }}

  deploy:
    name: Deploy to Server
    needs: test
    runs-on: self-hosted  # Uses self-hosted runner on your network
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy with rollback support
        run: |
          set -e

          echo "ğŸš€ Starting deployment..."
          cd ${{ env.DEPLOY_PATH }}

          # Store current image as backup
          CURRENT_IMAGE=$(docker images -q ${{ env.DOCKER_IMAGE }}:latest)
          if [ ! -z "$CURRENT_IMAGE" ]; then
            echo "ğŸ“¦ Creating backup of current image..."
            docker tag ${{ env.DOCKER_IMAGE }}:latest ${{ env.DOCKER_IMAGE }}:backup || true
          fi

          # Pull latest code
          echo "ğŸ“¥ Pulling latest code..."
          git fetch origin main
          git reset --hard origin/main

          # Build new image
          echo "ğŸ”¨ Building new Docker image..."
          docker compose build --no-cache

          # Stop current container
          echo "ğŸ›‘ Stopping current container..."
          docker compose down || true

          # Start new container
          echo "â–¶ï¸  Starting new container..."
          docker compose up -d

          # Wait for health check
          echo "â³ Waiting for container to be healthy..."
          sleep 15

          # Check if container is running and healthy
          if docker compose ps | grep -q "Up"; then
            if curl -f -s http://localhost:3000 > /dev/null; then
              echo "âœ… Deployment successful!"

              # Clean up old backup
              if [ ! -z "$CURRENT_IMAGE" ]; then
                docker rmi ${{ env.DOCKER_IMAGE }}:backup 2>/dev/null || true
              fi

              # Clean up dangling images
              docker image prune -f

              exit 0
            else
              echo "âŒ Health check failed - app not responding!"
              exit 1
            fi
          else
            echo "âŒ Container failed to start!"
            exit 1
          fi

      - name: Rollback on failure
        if: failure()
        run: |
          set -e

          echo "ğŸ”„ Deployment failed! Rolling back..."
          cd ${{ env.DEPLOY_PATH }}

          # Stop failed container
          docker compose down || true

          # Check if backup image exists
          if docker images | grep -q "${{ env.DOCKER_IMAGE }}.*backup"; then
            echo "ğŸ“¦ Restoring backup image..."

            # Remove failed image
            docker rmi ${{ env.DOCKER_IMAGE }}:latest 2>/dev/null || true

            # Restore backup
            docker tag ${{ env.DOCKER_IMAGE }}:backup ${{ env.DOCKER_IMAGE }}:latest

            # Start old container
            docker compose up -d

            # Wait and verify
            sleep 10

            if docker compose ps | grep -q "Up"; then
              echo "âœ… Rollback successful! Service restored."
            else
              echo "âŒ Rollback failed! Manual intervention required."
              exit 1
            fi
          else
            echo "âš ï¸  No backup image found. Manual intervention required."
            exit 1
          fi

      - name: Notify on success
        if: success()
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Site is live at your production URL"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed and rollback was attempted"
          echo "ğŸ“§ Check your server logs for details"
